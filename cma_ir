import socket
import io
from PIL import Image
import matplotlib.pyplot as plt

# Configurações do servidor no notebook
HOST = '0.0.0.0'  # Escuta em todas as interfaces de rede
PORT = 8080  # Porta que o servidor vai escutar

def receive_image():
    # Criar o socket do servidor
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.bind((HOST, PORT))
    server_socket.listen(1)
    print(f'Servidor ouvindo na porta {PORT}...')

    # Aguardar por um cliente (o Raspberry Pi) se conectar
    conn, addr = server_socket.accept()
    print(f'Cliente conectado: {addr}')

    # Receber os dados da imagem
    image_data = b""
    while True:
        data = conn.recv(1024)
        if not data:
            break
        image_data += data

    # Fechar a conexão após a recepção da imagem
    conn.close()

    # Carregar a imagem recebida em um buffer
    image_stream = io.BytesIO(image_data)
    image = Image.open(image_stream)

    # Exibir a imagem recebida
    plt.imshow(image)
    plt.title('Imagem Recebida')
    plt.show()

# Função principal para iniciar o servidor
if __name__ == '__main__':
    receive_image()
