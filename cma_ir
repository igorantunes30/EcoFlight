import socket
import time
from picamera2 import Picamera2

# Configurações da câmera
picam2 = Picamera2()

# IP e porta do notebook (servidor)
NOTEBOOK_IP = '192.168.137.1'  # Substitua pelo IP do notebook
NOTEBOOK_PORT = 8080  # Porta que o servidor do notebook está escutando

# Função para capturar e enviar a imagem armazenada
def send_image():
    while True:
        # Caminho da imagem a ser capturada
        IMAGE_PATH = 'captured_image.jpg'

        # Captura a imagem e salva no caminho especificado
        picam2.start()
        picam2.capture_file(IMAGE_PATH)
        picam2.stop()

        # Abre o arquivo da imagem capturada
        with open(IMAGE_PATH, 'rb') as image_file:
            # Conectando ao notebook
            client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            client_socket.connect((NOTEBOOK_IP, NOTEBOOK_PORT))

            # Envia a imagem em pacotes de 1024 bytes
            while True:
                chunk = image_file.read(1024)  # Lê 1024 bytes por vez
                if not chunk:
                    break  # Sai do loop se não houver mais dados
                client_socket.send(chunk)

            # Finaliza a transmissão
            client_socket.close()
            print("Imagem enviada com sucesso!")

        # Aguarda 1 segundo antes de capturar e enviar a próxima imagem
        time.sleep(1)

# Envia imagens continuamente a cada 1 segundo
send_image()
